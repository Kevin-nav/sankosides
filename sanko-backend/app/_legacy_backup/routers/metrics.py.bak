"""
Metrics Router

Exposes pipeline metrics for development and debugging.
Controlled by DEV_MODE and EXPOSE_METRICS env variables.

Endpoints:
- GET /api/metrics - Get all metrics with full per-call data
- GET /api/metrics/summary - Summary only (no raw data)
- GET /api/metrics/calls - Per-call details with prompts/outputs/thinking
- GET /api/metrics/call/:index - Single call details
- GET /api/metrics/pricing - Get pricing information
- POST /api/metrics/reset - Reset metrics
"""

from fastapi import APIRouter, HTTPException, Query
from typing import Dict, Any, Optional

from app.config import settings
from app.services.metrics import get_metrics_tracker, PRICING, reset_metrics_tracker

router = APIRouter()


@router.get("/")
async def get_metrics(
    include_raw: bool = Query(True, description="Include full prompts, outputs, and thinking content")
) -> Dict[str, Any]:
    """
    Get all metrics including per-call data.
    
    For testing environment: includes full prompts, model outputs, and thinking content.
    Only available when EXPOSE_METRICS=true (default in dev).
    """
    if not settings.expose_metrics:
        raise HTTPException(
            status_code=403,
            detail="Metrics endpoint disabled. Set EXPOSE_METRICS=true to enable."
        )
    
    tracker = get_metrics_tracker()
    return tracker.to_dict(include_raw=include_raw)


@router.get("/summary")
async def get_metrics_summary() -> Dict[str, Any]:
    """
    Get summary metrics only (no per-call details).
    
    Good for dashboards that just need totals.
    """
    if not settings.expose_metrics:
        raise HTTPException(
            status_code=403,
            detail="Metrics endpoint disabled. Set EXPOSE_METRICS=true to enable."
        )
    
    tracker = get_metrics_tracker()
    return tracker.summary().model_dump()


@router.get("/calls")
async def get_all_calls(
    limit: int = Query(100, description="Max number of calls to return"),
    offset: int = Query(0, description="Offset for pagination"),
) -> Dict[str, Any]:
    """
    Get all per-call data with prompts, outputs, and thinking content.
    
    This is the main endpoint for the testing environment.
    Use this to analyze prompts and iterate on system messages.
    """
    if not settings.expose_metrics:
        raise HTTPException(
            status_code=403,
            detail="Metrics endpoint disabled. Set EXPOSE_METRICS=true to enable."
        )
    
    tracker = get_metrics_tracker()
    all_data = tracker.to_dict(include_raw=True)
    
    calls = all_data.get("calls", [])
    paginated = calls[offset:offset + limit]
    
    return {
        "total": len(calls),
        "offset": offset,
        "limit": limit,
        "calls": paginated,
    }


@router.get("/calls/{index}")
async def get_single_call(index: int) -> Dict[str, Any]:
    """
    Get a single call by index.
    
    Useful for inspecting a specific agent execution.
    """
    if not settings.expose_metrics:
        raise HTTPException(
            status_code=403,
            detail="Metrics endpoint disabled. Set EXPOSE_METRICS=true to enable."
        )
    
    tracker = get_metrics_tracker()
    all_data = tracker.to_dict(include_raw=True)
    calls = all_data.get("calls", [])
    
    if index < 0 or index >= len(calls):
        raise HTTPException(
            status_code=404,
            detail=f"Call index {index} not found. Valid range: 0-{len(calls)-1}"
        )
    
    return {
        "index": index,
        "call": calls[index],
    }


@router.get("/calls/agent/{agent_name}")
async def get_calls_by_agent(agent_name: str) -> Dict[str, Any]:
    """
    Get all calls for a specific agent.
    
    Useful for analyzing performance of a single agent type.
    """
    if not settings.expose_metrics:
        raise HTTPException(
            status_code=403,
            detail="Metrics endpoint disabled. Set EXPOSE_METRICS=true to enable."
        )
    
    tracker = get_metrics_tracker()
    all_data = tracker.to_dict(include_raw=True)
    calls = all_data.get("calls", [])
    
    agent_calls = [c for c in calls if c.get("agent_name") == agent_name]
    
    return {
        "agent_name": agent_name,
        "total": len(agent_calls),
        "calls": agent_calls,
    }


@router.get("/pricing")
async def get_pricing() -> Dict[str, Any]:
    """
    Get current model pricing information.
    
    Returns pricing per 1M tokens for each model.
    """
    if not settings.expose_metrics:
        raise HTTPException(
            status_code=403,
            detail="Metrics endpoint disabled. Set EXPOSE_METRICS=true to enable."
        )
    
    return {
        "currency": "USD",
        "unit": "per 1M tokens",
        "models": PRICING,
        "note": "Prices as of December 2025"
    }


@router.post("/reset")
async def reset_metrics() -> Dict[str, str]:
    """
    Reset all metrics (start fresh tracking).
    
    Useful between test runs.
    """
    if not settings.dev_mode:
        raise HTTPException(
            status_code=403,
            detail="Reset only available in dev mode. Set DEV_MODE=true to enable."
        )
    
    reset_metrics_tracker()
    
    return {"status": "ok", "message": "Metrics reset successfully"}
